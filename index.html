<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>予約キャンセル</title>
</head>

<body>
<div id="form-page" class="page active">
  <h2 class="page-title">以下の予約をキャンセルしますか？</h2>
  <div id="reservation-info">読み込み中...</div>
  <div id="buttons">
    <button id="yesBtn">はい</button>
    <button id="noBtn">いいえ</button>
  </div>
  <p id="result"></p>
</div>

<script>
const postwebhookURL = "https://reservations.thinklayer.jp/"; //送信用webhookUrl
const webhookURL = "https://reservations.thinklayer.jp/";     //get用webhookUrl
const Params = new URLSearchParams(window.location.search);
const userId = Params.get("userId");
const webappurl = Params.get("webappurl");
const sheetId = urlParams.get("sheetId");

window.onload = function() {

// -----------------------------
// CSSパラメータ設定
// -----------------------------
  // CSS 読み込み
  const cssFile = Params.get("css") || "style.css";
  const link = document.createElement("link");
  link.rel = "stylesheet";
  link.href = cssFile;
  document.head.appendChild(link);

// カスタムカラー設定
const root = document.documentElement;
const colorMap = {
			pageTitleColor: "--color-page-title",
			bodyColor: "--color-body",
			bgForm: "--form-bg",
			buttonTextColor: "--color-button-text",
			bgButton: "--bg-button"
};


for (const key in colorMap) {
  const value = Params.get(key);
  if (value) root.style.setProperty(colorMap[key], value);
}

//～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～
  //　--- 背景画像設定 --- //
  const bgImageParam = Params.get("bgimage"); // URLパラメータ名を「bgimage」に設定
  const body = document.body;

  if(bgImageParam && bgImageParam.trim() !== ""){
    // URLパラメータがある場合はそのURLを使用
	   body.style.background = `url("${bgImageParam}") no-repeat center center fixed`;
	} else {
	  // bgimageが無い場合
	  if (cssFile === "style_huwa.css") {
		// huwa の場合
		body.style.background = 'url("background-huwa.jpg") no-repeat center center fixed';
	  } else if (cssFile === "style_luxury.css") {
		// luxury の場合
		body.style.background = 'url("background-luxury.jpg") no-repeat center center fixed';
	  } else {
		// その他
		body.style.background = 'url("background.jpg") no-repeat center center fixed';
	  }
	}
body.style.backgroundSize = "cover";
//～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～


  // -----------------------------
  // 予約情報取得（Workers 経由）
  // -----------------------------
  let reservationData;
  fetch(webhookURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ webappurl: webappurl, userId: userId, cancel: true, sheetId: sheetId })
  })
  .then(res => res.text())
.then(text => {
  try {
    reservationData = JSON.parse(text);
    if (reservationData.start && reservationData.staff) {
        document.getElementById('reservation-info').innerHTML =
          `<div class="reservation-wrapper">
            <table class="reservation-table">
              <tr><td class="label">予約日:</td><td class="value">${reservationData.start}</td></tr>
              <tr><td class="label">予約メニュー:</td><td class="value">${reservationData.menu}</td></tr>
              <tr><td class="label">金額:</td><td class="value">${reservationData.price}円</td></tr>
              <tr><td class="label">担当:</td><td class="value">${reservationData.staff}</td></tr>
            </div>
          </form>`;

    } else {
      document.getElementById('reservation-info').textContent = reservationData.message || "現在ご予約はありません";
      document.getElementById('buttons').style.display = 'none';
    }
  } catch(err) {
    document.getElementById('reservation-info').textContent = "予約情報の取得に失敗しました";
    console.error(err);
    document.getElementById('buttons').style.display = 'none';
  }
})
.catch(err => {
  document.getElementById('reservation-info').textContent = "予約情報の取得に失敗しました";
  console.error(err);
  document.getElementById('buttons').style.display = 'none';
});


  // -----------------------------
  // キャンセルアクション
  // -----------------------------
  document.getElementById('yesBtn').onclick = () => sendAction('yes');
  document.getElementById('noBtn').onclick = () => sendAction('no');

function sendAction(action) {
  if (action === 'yes') {
    // 予約情報がなければアラート
    if (!reservationData || !reservationData.rowNumber) {
      alert("キャンセル対象の予約がありません");
      return;
    }

    // --- ここでローディング表示を出す ---
    document.getElementById('result').innerHTML = "キャンセル中です<br>お待ちください…";
    document.getElementById('buttons').style.display = 'none';


    // サーバーへ送信
    fetch(postwebhookURL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        webappurl: webappurl,
        userId: userId,
		sheetId: sheetId,
        cancelAction: true,
        rowNumber: reservationData.rowNumber
      })
    })
    .then(res => res.text())
    .then(text => {
      let json;
      try {
        json = JSON.parse(text);
      } catch(e) {
        throw new Error(`JSON parse error: ${text}`);
      }

      // --- 結果に置き換える ---
	  document.getElementById('result').innerHTML = "ご予約の削除をさせていただきました<br>またのご予約お待ちしております";

      document.getElementById('buttons').style.display = 'none';
    })
    .catch(err => {

        console.error(err);
		
	  // 画面にも表示する
      document.getElementById('result').innerHTML = "送信に失敗しました<br>もう一度お試しください";
	  // ボタンを復活させる
	  document.getElementById('buttons').style.display = 'block';
    });

  } else if (action === 'no') {
    // 「いいえ」の場合はメッセージだけ表示
    document.getElementById('result').textContent = "またのご利用をお待ちしております";
    document.getElementById('buttons').style.display = 'none';
  }
}

};
</script>
</body>
</html>























